{"changed":false,"filter":false,"title":"actionable.php","tooltip":"/actionable/controllers/admin/actionable.php","value":"<?php defined('SYSPATH') or die('No direct script access.');\n/**\n * Actionable Controller\n *\n * PHP version 5\n * LICENSE: This source file is subject to LGPL license \n * that is available through the world-wide-web at the following URI:\n * http://www.gnu.org/copyleft/lesser.html\n * @author\t\t Ushahidi Team <team@ushahidi.com> \n * @package\t\tUshahidi - http://source.ushahididev.com\n * @module\t\t Actionable Controller\t\n * @copyright\tUshahidi - http://www.ushahidi.com\n * @license\t\thttp://www.gnu.org/copyleft/lesser.html GNU Lesser General Public License (LGPL) \n* \n*/\n// Manually require the admin reports controller - so we don't get the frontend controller instead\nrequire_once(Kohana::find_file('controllers', 'admin/reports'));\n\nclass Actionable_Controller extends Reports_Controller {\n\t\n\t//public $auto_render = FALSE;\n\t\n\tpublic function __construct()\n\t{\n\t\tparent::__construct();\n\t\t\n\t\t$this->template->this_page = 'actionable';\n\t}\n\t\n\tpublic function index($page = 1)\n\t{\n\t\t// If user doesn't have access, redirect to dashboard\n\t\tif ( ! admin::permissions($this->user, \"reports_view\"))\n\t\t{\n\t\t\turl::redirect(url::site().'admin/dashboard');\n\t\t}\n\t\t\n\t\t// Set status\n\t\t//$this->template->content->status = $status;\n\t\t$status = \"0\";\n\t\tif ( !empty($_GET['status']))\n\t\t{\n\t\t\t$status = $_GET['status'];\n\n\t\t\tif (strtolower($status) == 'action')\n\t\t\t{\n\t\t\t\t$actionable_filter = 'actionable = 1 AND action_taken = 0';\n\t\t\t\t$this->params['actionable'] = 'i.id IN (SELECT DISTINCT incident_id FROM `'.Kohana::config('database.default.table_prefix').'actionable` WHERE actionable = 1 AND action_taken = 0)';\n\t\t\t}\n\t\t\telseif (strtolower($status) == 'urgent')\n\t\t\t{\n\t\t\t\t$actionable_filter = 'actionable = 2 AND action_taken = 0';\n\t\t\t\t$this->params['actionable'] = 'i.id IN (SELECT DISTINCT incident_id FROM `'.Kohana::config('database.default.table_prefix').'actionable` WHERE actionable = 2 AND action_taken = 0)';\n\t\t\t}\n\t\t\telseif (strtolower($status) == 'taken')\n\t\t\t{\n\t\t\t\t$actionable_filter = 'action_taken = 1';\n\t\t\t\t$this->params['actionable'] = 'i.id IN (SELECT DISTINCT incident_id FROM `'.Kohana::config('database.default.table_prefix').'actionable` WHERE action_taken = 1)';\n\t\t\t}\n\t\t\telseif (strtolower($status) == 'na')\n\t\t\t{\n\t\t\t\t$actionable_filter = 'actionable = 0 AND action_taken = 0';\n\t\t\t\t$this->params['actionable'] = '(\n\t\t\t\t\ti.id IN (SELECT DISTINCT incident_id FROM `'.Kohana::config('database.default.table_prefix').'actionable` WHERE actionable = 0 AND action_taken = 0) OR\n\t\t\t\t\ti.id NOT IN (SELECT DISTINCT incident_id FROM `'.Kohana::config('database.default.table_prefix').'actionable`)\n\t\t\t\t)';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$status = \"0\";\n\t\t\t}\n\t\t}\n\t\t\n\t\tparent::index($page);\n\t\t\n\t\t$this->template->content->status = $status;\n\t\t\n\t\t// Grab all actionable entries at once\n\t\t$factory = ORM::factory('actionable');\n\t\tif (isset($actionable_filter)) $factory->where($actionable_filter);\n\t\t\n\t\t$actionables = array();\n\t\tforeach ($factory->find_all() as $actionable) {\n\t\t\t$actionables[$actionable->incident_id] = $actionable;\n\t\t}\n\t\t\n\t\t$incidents = array();\n\t\tforeach ($this->template->content->incidents as $k => $incident)\n\t\t{\n\t\t\tif (isset($actionables[$incident->incident_id]))\n\t\t\t{\n\t\t\t\t$incident->actionable = $actionables[$incident->incident_id]->status();\n\t\t\t}\n\t\t\t$incidents[] = $incident;\n\t\t}\n\t\t$this->template->content->incidents = $incidents;\n\t\t\n\t\t// Set the filename\n\t\t$this->template->content->set_filename('admin/actionable');\n\t\t//$this->template->render();\n\t}\n}\n","undoManager":{"mark":-1,"position":-1,"stack":[]},"ace":{"folds":[],"scrolltop":0,"scrollleft":6,"selection":{"start":{"row":11,"column":25},"end":{"row":11,"column":25},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1407766781000}